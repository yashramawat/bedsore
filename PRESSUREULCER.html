<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICU Pressure Injury Assessment Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; padding: 20px; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:25px; text-align:center; }
        .header h1 { font-size:24px; margin-bottom:5px; }
        .header p { font-size:14px; opacity:0.9; }
        .form-container { padding:30px; }
        .section { margin-bottom:30px; padding:20px; border-radius:8px; background:#f8f9fa; border-left:4px solid #667eea; }
        .section.risk-high { border-left-color:#dc3545; background:#fff5f5; }
        .section.risk-moderate { border-left-color:#fd7e14; background:#fff8f0; }
        .section.risk-low { border-left-color:#28a745; background:#f0fff4; }
        .section-title { font-size:18px; font-weight:600; color:#333; margin-bottom:15px; display:flex; align-items:center; }
        .section-title span { background:#667eea; color:#fff; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:10px; font-size:14px; }
        .form-group { margin-bottom:20px; }
        .form-group label { display:block; font-weight:600; color:#495057; margin-bottom:8px; font-size:14px; }
        .required { color:#dc3545; margin-left:3px; }
        .form-group input[type=text],
        .form-group input[type=date],
        .form-group input[type=time],
        .form-group select,
        .form-group textarea { width:100%; padding:10px 12px; border:1px solid #ced4da; border-radius:5px; font-size:14px; transition:border-color .3s; }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.1); }
        .radio-group,.checkbox-group { display:flex; gap:20px; flex-wrap:wrap; }
        .radio-option,.checkbox-option { display:flex; align-items:center; gap:8px; cursor:pointer; }
        .radio-option input[type=radio],
        .checkbox-option input[type=checkbox] { width:18px; height:18px; cursor:pointer; }
        .conditional-field { display:none; margin-top:15px; padding:15px; background:#fff; border-radius:5px; border:1px solid #e9ecef; }
        .injury-sites { display:none; margin-top:20px; padding:20px; background:#fff; border-radius:8px; border:2px solid #667eea; }
        .site-staging { margin-top:15px; padding:15px; background:#f8f9fa; border-radius:5px; border-left:3px solid #fd7e14; }
        .site-staging h4 { color:#495057; margin-bottom:10px; font-size:15px; }
        .stage-options { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; }
        .signature-pad { border:2px dashed #ced4da; border-radius:5px; background:#fff; cursor:crosshair; touch-action:none; }
        .signature-controls { margin-top:10px; display:flex; gap:10px; }
        .btn { padding:12px 24px; border:none; border-radius:5px; font-size:14px; font-weight:600; cursor:pointer; transition:all .3s; }
        .btn-primary { background:#667eea; color:#fff; }
        .btn-primary:hover { background:#5568d3; transform:translateY(-2px); box-shadow:0 4px 8px rgba(102,126,234,.3); }
        .btn-secondary { background:#6c757d; color:#fff; }
        .btn-secondary:hover { background:#5a6268; }
        .btn-danger { background:#dc3545; color:#fff; }
        .btn-success { background:#28a745; color:#fff; }
        .btn-success:hover { background:#218838; }
        .action-buttons { display:flex; gap:15px; justify-content:center; margin-top:30px; padding-top:30px; border-top:2px solid #e9ecef; }
        .json-output { display:none; margin-top:20px; padding:20px; background:#282c34; color:#abb2bf; border-radius:8px; font-family:'Courier New',monospace; font-size:12px; max-height:400px; overflow-y:auto; }
        .grid-2 { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; }
        .risk-indicator { padding:10px; border-radius:5px; text-align:center; font-weight:600; margin-top:10px; display:none; }
        .risk-high-indicator { background:#dc3545; color:#fff; border:3px solid #c82333; }
        .risk-moderate-indicator { background:#fd7e14; color:#fff; border:3px solid #e96b00; }
        .risk-low-indicator { background:#28a745; color:#fff; border:3px solid #1e7e34; }
        @media (max-width:768px){ body{padding:10px;} .form-container{padding:20px;} .section{padding:15px;} .grid-2{grid-template-columns:1fr;} .action-buttons{flex-direction:column;} .btn{width:100%;} }
    </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ICU Pressure Injury Assessment Tool</h1>
    <p>Risk assessment, prevention and documentation</p>
  </div>
  <div class="form-container">
    <form id="assessmentForm">

      <!-- A) ICU SELECTION -->
      <div class="section">
        <div class="section-title"><span>A</span>ICU Selection</div>
        <div class="form-group">
          <label for="icuType">Select ICU Type <span class="required">*</span></label>
          <select id="icuType" name="icuType" required>
            <option value="">-- Select ICU --</option>
            <option value="neuro">Neuro ICU (12 beds)</option>
            <option value="neurosurgery">Neurosurgery ICU (12 beds)</option>
            <option value="hdu">HDU (12 beds)</option>
            <option value="trauma">Trauma ICU - 2nd Floor (12 beds)</option>
            <option value="aicu">AICU (35 beds)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="bedNumber">Bed Number <span class="required">*</span></label>
          <select id="bedNumber" name="bedNumber" required disabled>
            <option value="">-- Select ICU First --</option>
          </select>
        </div>
        <div class="form-group">
          <label for="admissionDate">Date of Admission <span class="required">*</span></label>
          <input type="date" id="admissionDate" name="admissionDate" required>
        </div>
      </div>

      <!-- B) DATE TIME -->
      <div class="section">
        <div class="section-title"><span>B</span>Date & Time</div>
        <div class="grid-2">
          <div class="form-group">
            <label for="assessmentDate">Assessment Date</label>
            <input type="date" id="assessmentDate" name="assessmentDate" readonly>
          </div>
          <div class="form-group">
            <label for="assessmentTime">Assessment Time</label>
            <input type="time" id="assessmentTime" name="assessmentTime" readonly>
          </div>
        </div>
      </div>

      <!-- C) HIGH-RISK COLOR ALERT (SIMPLIFIED BRADEN) -->
      <div class="section" id="bradenSection">
        <div class="section-title"><span>C</span>Risk Level (Braden)</div>
        <div class="form-group">
          <label for="bradenRisk">Pressure Injury Risk <span class="required">*</span></label>
          <select id="bradenRisk" name="bradenRisk" required>
            <option value="">-- Select Risk --</option>
            <option value="high">High Risk</option>
            <option value="moderate">Moderate Risk</option>
            <option value="low">Low Risk</option>
          </select>
        </div>
        <div id="bradenRiskIndicator" class="risk-indicator"></div>
      </div>

      <!-- 3) PREVENTION MEASURES -->
      <div class="section">
        <div class="section-title"><span>3</span>Prevention Measures</div>
        <div class="form-group">
          <label>3A. Air Mattress in Use? <span class="required">*</span></label>
          <div class="radio-group">
            <label class="radio-option"><input type="radio" name="airMattress" value="yes" required><span>Yes</span></label>
            <label class="radio-option"><input type="radio" name="airMattress" value="no"><span>No</span></label>
          </div>
          <div id="airMattressReason" class="conditional-field">
            <label>Reason for No Air Mattress <span class="required">*</span></label>
            <select name="airMattressReasonType">
              <option value="">-- Select Reason --</option>
              <option value="notAvailable">Not Available</option>
              <option value="unstable">Patient Unstable</option>
              <option value="other">Other</option>
            </select>
            <input type="text" name="airMattressReasonText" placeholder="Specify other reason..." style="margin-top:10px;display:none;">
          </div>
        </div>
        <div class="form-group">
          <label>3B. Repositioning Done? <span class="required">*</span></label>
          <div class="radio-group">
            <label class="radio-option"><input type="radio" name="repositioning" value="yes" required><span>Yes</span></label>
            <label class="radio-option"><input type="radio" name="repositioning" value="no"><span>No</span></label>
          </div>
          <div id="repositioningReason" class="conditional-field">
            <label>Reason for No Repositioning <span class="required">*</span></label>
            <textarea name="repositioningReasonText" rows="2" placeholder="Enter reason..."></textarea>
          </div>
        </div>
        <div class="form-group">
          <label>3C. Repositioning as per Schedule? <span class="required">*</span></label>
          <div class="radio-group">
            <label class="radio-option"><input type="radio" name="repositioningSchedule" value="yes" required><span>Yes</span></label>
            <label class="radio-option"><input type="radio" name="repositioningSchedule" value="no"><span>No</span></label>
          </div>
        </div>
        <div class="form-group">
          <label>Proper Weight Off-loading Done? <span class="required">*</span></label>
          <div class="radio-group">
            <label class="radio-option"><input type="radio" name="offloading" value="yes" required><span>Yes</span></label>
            <label class="radio-option"><input type="radio" name="offloading" value="no"><span>No</span></label>
          </div>
        </div>
      </div>

      <!-- 4) PRESSURE INJURY STATUS -->
      <div class="section">
        <div class="section-title"><span>4</span>Pressure Injury Status</div>
        <div class="form-group">
          <label>Pressure Injury Present? <span class="required">*</span></label>
          <div class="radio-group">
            <label class="radio-option"><input type="radio" name="pressureInjury" value="yes" required><span>Yes</span></label>
            <label class="radio-option"><input type="radio" name="pressureInjury" value="no"><span>No</span></label>
            <label class="radio-option"><input type="radio" name="pressureInjury" value="notAble"><span>Not Able to Assess</span></label>
          </div>
          <div id="notAbleReason" class="conditional-field">
            <label>Reason for Unable to Assess <span class="required">*</span></label>
            <select name="notAbleReasonType">
              <option value="">-- Select Reason --</option>
              <option value="unstable">Patient Unstable</option>
              <option value="prone">Patient in Prone Position</option>
              <option value="procedure">Procedure in Progress</option>
              <option value="other">Other</option>
            </select>
            <input type="text" name="notAbleReasonText" placeholder="Specify other reason..." style="margin-top:10px;display:none;">
          </div>
          <div id="injuryDateTime" class="conditional-field">
            <label>Pressure Injury Development Date <span class="required">*</span></label>
            <input type="date" id="injuryDate" name="injuryDate">
            <label style="margin-top:10px;">Development Time <span class="required">*</span></label>
            <input type="time" id="injuryTime" name="injuryTime">
          </div>
        </div>
      </div>

      <!-- 5) LOCATION & STAGE (IF YES) -->
      <div id="injurySitesSection" class="injury-sites">
        <div class="section-title"><span>5</span>Pressure Injury Location & Stage</div>
        <div class="form-group">
          <label>5A. Select Injury Site(s)</label>
          <div class="checkbox-group">
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="sacrum"><span>Sacrum</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="heel_right"><span>Heel - Right</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="heel_left"><span>Heel - Left</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="heel_both"><span>Heel - Both</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="trochanter_right"><span>Trochanter - Right</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="trochanter_left"><span>Trochanter - Left</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="trochanter_both"><span>Trochanter - Both</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="elbow_right"><span>Elbow - Right</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="elbow_left"><span>Elbow - Left</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="elbow_both"><span>Elbow - Both</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="shoulder_right"><span>Shoulder - Right</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="shoulder_left"><span>Shoulder - Left</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="shoulder_both"><span>Shoulder - Both</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="occiput"><span>Occiput</span></label>
            <label class="checkbox-option"><input type="checkbox" name="injurySite" value="other"><span>Other</span></label>
          </div>
        </div>
        <div id="sitesStagingContainer"></div>
      </div>

      <!-- 6) SUPERVISION & SIGNATURE -->
      <div class="section">
        <div class="section-title"><span>6</span>Supervision</div>
        <div class="form-group">
          <label for="supervisorName">Supervisor Name <span class="required">*</span></label>
          <input type="text" id="supervisorName" name="supervisorName" required>
        </div>
        <div class="form-group">
          <label for="remarks">Remarks</label>
          <textarea id="remarks" name="remarks" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Supervisor Digital Signature <span class="required">*</span></label>
          <canvas id="signaturePad" class="signature-pad" width="400" height="150"></canvas>
          <div class="signature-controls">
            <button type="button" class="btn btn-danger" onclick="clearSignature()">Clear Signature</button>
          </div>
          <input type="hidden" id="signatureData" name="signatureData">
        </div>
      </div>

      <!-- 7) ACTIONS / OUTPUT -->
      <div class="action-buttons">
        <button type="button" class="btn btn-success" onclick="saveForm()">Save & Generate JSON</button>
        <button type="button" class="btn btn-primary" onclick="downloadExcel()">Download Excel</button>
        <button type="reset" class="btn btn-secondary" onclick="resetForm()">Reset Form</button>
      </div>
      <div id="jsonOutput" class="json-output"></div>
    </form>
  </div>
</div>

<script>
  let isDrawing = false, lastX = 0, lastY = 0;

  // set assessment date/time
  window.addEventListener('load', () => {
    const today = new Date();
    document.getElementById('assessmentDate').valueAsDate = today;
    document.getElementById('assessmentTime').value = today.toTimeString().slice(0,5);
    initSignaturePad();
  });

  // ICU -> beds
  document.getElementById('icuType').addEventListener('change', function(){
    const bedSelect = document.getElementById('bedNumber');
    bedSelect.innerHTML = '<option value="">-- Select Bed --</option>';
    bedSelect.disabled = false;
    let count = this.value === 'aicu' ? 35 : this.value ? 12 : 0;
    for(let i=1;i<=count;i++){
      const opt = document.createElement('option');
      opt.value = i; opt.textContent = 'Bed ' + i; bedSelect.appendChild(opt);
    }
  });

  // simplified Braden risk color alert
  document.getElementById('bradenRisk').addEventListener('change', function(){
    const val = this.value;
    const indicator = document.getElementById('bradenRiskIndicator');
    const section = document.getElementById('bradenSection');
    section.classList.remove('risk-high','risk-moderate','risk-low');
    indicator.classList.remove('risk-high-indicator','risk-moderate-indicator','risk-low-indicator');
    if(!val){ indicator.style.display='none'; return; }
    indicator.style.display='block';
    if(val==='high'){
      indicator.textContent = 'HIGH RISK';
      section.classList.add('risk-high');
      indicator.classList.add('risk-high-indicator');
    } else if(val==='moderate'){
      indicator.textContent = 'MODERATE RISK';
      section.classList.add('risk-moderate');
      indicator.classList.add('risk-moderate-indicator');
    } else {
      indicator.textContent = 'LOW RISK';
      section.classList.add('risk-low');
      indicator.classList.add('risk-low-indicator');
    }
  });

  // conditional fields
  document.querySelectorAll('input[name="airMattress"]').forEach(r=>{
    r.addEventListener('change',()=>{
      document.getElementById('airMattressReason').style.display = r.value==='no' ? 'block':'none';
    });
  });
  document.querySelector('select[name="airMattressReasonType"]').addEventListener('change',function(){
    document.querySelector('input[name="airMattressReasonText"]').style.display = this.value==='other'?'block':'none';
  });
  document.querySelectorAll('input[name="repositioning"]').forEach(r=>{
    r.addEventListener('change',()=>{
      document.getElementById('repositioningReason').style.display = r.value==='no' ? 'block':'none';
    });
  });
  document.querySelectorAll('input[name="pressureInjury"]').forEach(r=>{
    r.addEventListener('change',function(){
      const notAble = document.getElementById('notAbleReason');
      const injurySites = document.getElementById('injurySitesSection');
      const injuryDT = document.getElementById('injuryDateTime');
      notAble.style.display = this.value==='notAble'?'block':'none';
      const yes = this.value==='yes';
      injurySites.style.display = yes?'block':'none';
      injuryDT.style.display = yes?'block':'none';
    });
  });
  document.querySelector('select[name="notAbleReasonType"]').addEventListener('change',function(){
    document.querySelector('input[name="notAbleReasonText"]').style.display = this.value==='other'?'block':'none';
  });

  // injury sites staging
  document.querySelectorAll('input[name="injurySite"]').forEach(cb=>{
    cb.addEventListener('change',updateSitesStaging);
  });
  function updateSitesStaging(){
    const container = document.getElementById('sitesStagingContainer');
    container.innerHTML='';
    document.querySelectorAll('input[name="injurySite"]:checked').forEach(cb=>{
      const site = cb.value;
      const div = document.createElement('div');
      const label = site.replace('_',' ').replace('_',' ');
      const pretty = label.split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
      div.className='site-staging';
      div.innerHTML = `
        <h4>5B. Stage for ${pretty}</h4>
        <div class="stage-options">
          <label class="radio-option"><input type="radio" name="stage_${site}" value="stage1" required><span>Stage 1</span></label>
          <label class="radio-option"><input type="radio" name="stage_${site}" value="stage2"><span>Stage 2</span></label>
          <label class="radio-option"><input type="radio" name="stage_${site}" value="stage3"><span>Stage 3</span></label>
          <label class="radio-option"><input type="radio" name="stage_${site}" value="stage4"><span>Stage 4</span></label>
          <label class="radio-option"><input type="radio" name="stage_${site}" value="unstageable"><span>Unstageable</span></label>
          <label class="radio-option"><input type="radio" name="stage_${site}" value="dti"><span>DTI</span></label>
        </div>`;
      container.appendChild(div);
    });
  }

  // signature pad
  function initSignaturePad(){
    const canvas = document.getElementById('signaturePad');
    const ctx = canvas.getContext('2d');
    ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.lineCap='round';
    canvas.addEventListener('mousedown',startDraw);
    canvas.addEventListener('mousemove',draw);
    canvas.addEventListener('mouseup',stopDraw);
    canvas.addEventListener('mouseout',stopDraw);
    canvas.addEventListener('touchstart',touchHandler,{passive:false});
    canvas.addEventListener('touchmove',touchHandler,{passive:false});
    canvas.addEventListener('touchend',stopDraw);
  }
  function startDraw(e){ isDrawing=true; const r=e.target.getBoundingClientRect(); lastX=e.clientX-r.left; lastY=e.clientY-r.top; }
  function draw(e){ if(!isDrawing) return; const c=document.getElementById('signaturePad'); const ctx=c.getContext('2d'); const r=c.getBoundingClientRect(); const x=e.clientX-r.left; const y=e.clientY-r.top; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke(); lastX=x; lastY=y; document.getElementById('signatureData').value = c.toDataURL(); }
  function stopDraw(){ isDrawing=false; }
  function touchHandler(e){ e.preventDefault(); const t=e.touches[0]; const ev=new MouseEvent(e.type==='touchstart'?'mousedown':'mousemove',{clientX:t.clientX,clientY:t.clientY}); e.target.dispatchEvent(ev); }
  function clearSignature(){ const c=document.getElementById('signaturePad'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); document.getElementById('signatureData').value=''; }
  window.clearSignature = clearSignature;

  // collect data
  function collectFormData(){
    const f = document.getElementById('assessmentForm');
    const data = {
      metadata:{ submissionTimestamp:new Date().toISOString(), assessmentDate:f.assessmentDate.value, assessmentTime:f.assessmentTime.value },
      patientIdentification:{ icuType:f.icuType.options[f.icuType.selectedIndex].text, bedNumber:f.bedNumber.value, admissionDate:f.admissionDate.value },
      risk:{ level:f.bradenRisk.value },
      prevention:{
        airMattress:{ inUse:f.airMattress.value, reason:f.airMattress.value==='no'?{ type:f.airMattressReasonType.value, text:f.airMattressReasonText.value }:null },
        repositioning:{ done:f.repositioning.value, reason:f.repositioning.value==='no'?f.repositioningReasonText.value:null, asPerSchedule:f.repositioningSchedule.value, properOffloading:f.offloading.value }
      },
      pressureInjury:{
        present:f.pressureInjury.value,
        developmentDate:f.injuryDate.value || null,
        developmentTime:f.injuryTime.value || null,
        notAbleReason:f.pressureInjury.value==='notAble'?{ type:f.notAbleReasonType.value, text:f.notAbleReasonText.value }:null,
        sites:[]
      },
      supervision:{ supervisorName:f.supervisorName.value, remarks:f.remarks.value, signatureSaved:document.getElementById('signatureData').value? 'Yes':'No', signatureTimestamp:new Date().toISOString() }
    };
    document.querySelectorAll('input[name="injurySite"]:checked').forEach(cb=>{
      const site = cb.value;
      const st = document.querySelector(`input[name="stage_${site}"]:checked`);
      if(st){ data.pressureInjury.sites.push({location:site,stage:st.value}); }
    });
    return data;
  }

  function saveForm(){
    const f = document.getElementById('assessmentForm');
    if(!f.checkValidity()){ alert('Please fill all required fields'); f.reportValidity(); return; }
    if(!document.getElementById('signatureData').value){ alert('Please provide supervisor signature'); return; }
    const data = collectFormData();
    const box = document.getElementById('jsonOutput');
    box.style.display='block';
    box.textContent = JSON.stringify(data,null,2);
    alert('Form saved. JSON shown below.');
  }
  window.saveForm = saveForm;

  function downloadExcel(){
    const f=document.getElementById('assessmentForm');
    if(!f.checkValidity()){ alert('Please fill all required fields'); f.reportValidity(); return; }
    const d = collectFormData();
    let csv = 'ICU Pressure Injury Assessment\n\n';
    csv += 'PATIENT IDENTIFICATION\n';
    csv += `ICU Type,${d.patientIdentification.icuType}\n`;
    csv += `Bed Number,${d.patientIdentification.bedNumber}\n`;
    csv += `Admission Date,${d.patientIdentification.admissionDate}\n`;
    csv += `Assessment Date,${d.metadata.assessmentDate}\n`;
    csv += `Assessment Time,${d.metadata.assessmentTime}\n\n`;
    csv += 'RISK LEVEL\n';
    csv += `Risk Level,${d.risk.level}\n\n`;
    csv += 'PREVENTION MEASURES\n';
    csv += `Air Mattress,${d.prevention.airMattress.inUse}\n`;
    csv += `Repositioning Done,${d.prevention.repositioning.done}\n`;
    csv += `As Per Schedule,${d.prevention.repositioning.asPerSchedule}\n`;
    csv += `Proper Off-loading,${d.prevention.repositioning.properOffloading}\n\n`;
    csv += 'PRESSURE INJURY STATUS\n';
    csv += `Injury Present,${d.pressureInjury.present}\n`;
    csv += `Development Date,${d.pressureInjury.developmentDate || ''}\n`;
    csv += `Development Time,${d.pressureInjury.developmentTime || ''}\n`;
    if(d.pressureInjury.sites.length){
      csv += 'Sites & Stages\n';
      d.pressureInjury.sites.forEach(s=>{ csv += `${s.location},${s.stage}\n`; });
    }
    csv += '\nSUPERVISION\n';
    csv += `Supervisor Name,${d.supervision.supervisorName}\n`;
    csv += `Signature Saved,${d.supervision.signatureSaved}\n`;
    csv += `Remarks,${d.supervision.remarks}\n`;
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=`ICU_Assessment_${d.patientIdentification.bedNumber}_${d.metadata.assessmentDate}.csv`; a.click();
    URL.revokeObjectURL(url);
    alert('Excel file downloaded');
  }
  window.downloadExcel = downloadExcel;

  function resetForm(){
    if(!confirm('Reset form?')) return;
    document.getElementById('assessmentForm').reset();
    document.getElementById('jsonOutput').style.display='none';
    clearSignature();
    document.getElementById('bedNumber').disabled=true;
    document.getElementById('bradenRiskIndicator').style.display='none';
    const t=new Date();
    document.getElementById('assessmentDate').valueAsDate=t;
    document.getElementById('assessmentTime').value=t.toTimeString().slice(0,5);
    document.getElementById('injurySitesSection').style.display='none';
    document.getElementById('injuryDateTime').style.display='none';
    document.getElementById('airMattressReason').style.display='none';
    document.getElementById('repositioningReason').style.display='none';
    document.getElementById('notAbleReason').style.display='none';
    document.getElementById('sitesStagingContainer').innerHTML='';
  }
  window.resetForm = resetForm;
</script>
</body>
</html>